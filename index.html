<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Pengaduan FEBI</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .tab-content { padding: 20px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .btn-primary { background: #0d6efd; }
    .btn-success { background: #198754; }
    .card { border: none; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .progress-bar { border-radius: 5px; }
    .hidden { display: none; }
  </style>
</head>
<body>

<div class="container py-4">
  <h2 class="text-center mb-4">ðŸ“Š Dashboard Layanan Pengaduan FEBI UINSI</h2>
  <ul class="nav nav-tabs" id="myTab">
    <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#input">Input Aduan</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#respon">Input Respon</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#data">Data Aduan</a></li>
    <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#statistik">Statistik</a></li>
  </ul>

  <div class="tab-content" id="myTabContent">
    <!-- Tab 1: Input Aduan -->
    <div class="tab-pane fade show active" id="input">
      <h5 class="mt-3">Formulir Pengaduan</h5>
      <form id="formAduan">
        <div class="mb-3">
          <label>Nama</label>
          <input type="text" class="form-control" id="nama" required />
        </div>
        <div class="mb-3">
          <label>Jabatan</label>
          <select class="form-control" id="jabatan" required>
            <option value="Mahasiswa">Mahasiswa</option>
            <option value="Tendik">Tendik</option>
            <option value="Dosen">Dosen</option>
          </select>
        </div>
        <div class="mb-3">
          <label>Isi Aduan</label>
          <textarea class="form-control" id="isiAduan" rows="4" required></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Kirim Aduan</button>
      </form>
      <div id="resultAduan" class="alert alert-success mt-3 hidden"></div>
    </div>

    <!-- Tab 2: Input Respon -->
    <div class="tab-pane fade" id="respon">
      <h5 class="mt-3">Respon terhadap Aduan</h5>
      <div id="listAduanRespon"></div>
    </div>

    <!-- Tab 3: Data Aduan -->
    <div class="tab-pane fade" id="data">
      <h5 class="mt-3">Semua Data Aduan & Respon</h5>
      <div id="dataTable"></div>
    </div>

    <!-- Tab 4: Statistik -->
    <div class="tab-pane fade" id="statistik">
      <h5 class="mt-3">Statistik Pengaduan</h5>
      <div class="row">
        <div class="col-md-6">
          <canvas id="chartJabatan"></canvas>
        </div>
        <div class="col-md-6">
          <canvas id="chartStatus"></canvas>
        </div>
      </div>
      <div class="mt-4 card p-3">
        <h6>Ringkasan</h6>
        <ul id="summaryStats"></ul>
      </div>
    </div>
  </div>
</div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbxZUL1Ue16DZ4JW2_KkPFz9OthwjizNmmB_93PHXO7pDWr4Ygie9Y9dqh2QawA_4jrN/exec"; // GANTI INI!
  let allAduan = [];
  let allRespon = [];

  // Load data awal
  async function loadData() {
    try {
      const res = await fetch(`${API_URL}?sheet=Aduan`);
      allAduan = await res.json();
      renderResponList();
      renderDataTable();
      renderStats();
    } catch (e) {
      alert("Gagal memuat data. Cek koneksi atau URL API.");
    }
  }

  // Tab 1: Submit Aduan
  document.getElementById("formAduan").addEventListener("submit", async (e) => {
    e.preventDefault();
    const fd = new FormData();
    fd.append("action", "submitAduan");
    fd.append("nama", document.getElementById("nama").value);
    fd.append("jabatan", document.getElementById("jabatan").value);
    fd.append("isiAduan", document.getElementById("isiAduan").value);

    const res = await fetch(API_URL, { method: "POST", body: fd });
    const result = await res.json();

    document.getElementById("resultAduan").innerText = `Aduan berhasil dikirim! ID: ${result.id}`;
    document.getElementById("resultAduan").classList.remove("hidden");
    document.getElementById("formAduan").reset();
    setTimeout(() => loadData(), 1000);
  });

  // Tab 2: List Aduan + Tombol Aksi
  function renderResponList() {
    const div = document.getElementById("listAduanRespon");
    div.innerHTML = allAduan.map(aduan => `
      <div class="card mb-3 p-3">
        <strong>ID: ${aduan.ID}</strong> | ${aduan.Nama} (${aduan.Jabatan})<br>
        <small>"${aduan['Isi Aduan']}"</small>
        <button class="btn btn-sm btn-success mt-2" onclick="showResponForm('${aduan.ID}')">Tanggapi</button>
        <div id="formRespon-${aduan.ID}" class="mt-3 hidden">
          <label>Identifikasi Masalah</label>
          <input class="form-control mb-2" id="ident-${aduan.ID}" />
          <label>Sumber Masalah</label>
          <input class="form-control mb-2" id="sumber-${aduan.ID}" />
          <label>Rencana Aksi</label>
          <textarea class="form-control mb-2" id="aksi-${aduan.ID}"></textarea>
          <label>Waktu Penyelesaian</label>
          <input type="text" class="form-control mb-2" id="waktu-${aduan.ID}" placeholder="Contoh: 1 minggu" />
          <label>Penanggung Jawab</label>
          <input class="form-control mb-2" id="pj-${aduan.ID}" />
          <button class="btn btn-sm btn-primary" onclick="submitRespon('${aduan.ID}')">Simpan Respon</button>
        </div>
      </div>
    `).join("");
  }

  function showResponForm(id) {
    document.querySelectorAll(`[id^='formRespon-']`).forEach(el => el.classList.add("hidden"));
    document.getElementById(`formRespon-${id}`).classList.remove("hidden");
  }

  async function submitRespon(id) {
    const fd = new FormData();
    fd.append("action", "submitRespon");
    fd.append("id", id);
    fd.append("identifikasi", document.getElementById(`ident-${id}`).value);
    fd.append("sumber", document.getElementById(`sumber-${id}`).value);
    fd.append("aksi", document.getElementById(`aksi-${id}`).value);
    fd.append("waktu", document.getElementById(`waktu-${id}`).value);
    fd.append("penanggungjawab", document.getElementById(`pj-${id}`).value);

    await fetch(API_URL, { method: "POST", body: fd });
    alert("Respon berhasil disimpan!");
    loadData();
  }

  // Tab 3: Tampilkan semua data
  function renderDataTable() {
    const div = document.getElementById("dataTable");
    div.innerHTML = allAduan.map(aduan => `
      <div class="card mb-3 p-3">
        <h6>ID: ${aduan.ID} | ${aduan.Nama} (${aduan.Jabatan}) | Status: ${aduan.Status}</h6>
        <p><strong>Aduan:</strong> "${aduan['Isi Aduan']}"</p>
        <p><strong>Tanggal:</strong> ${new Date(aduan['Tanggal Aduan']).toLocaleString()}</p>
        <!-- Respon akan ditampilkan jika ada -->
        <div id="respon-${aduan.ID}"></div>
      </div>
    `).join("");

    // Ambil respon dari API (simulasi sederhana - bisa diperluas)
    // Untuk demo, kita asumsikan respon akan muncul setelah disimpan
    setTimeout(() => {
      allAduan.forEach(aduan => {
        const el = document.getElementById(`respon-${aduan.ID}`);
        if (el) el.innerHTML = `<div class="alert alert-info">Menunggu respon...</div>`;
      });
    }, 500);
  }

  // Tab 4: Statistik
  function renderStats() {
    // Statistik Jabatan
    const jabatanData = {};
    allAduan.forEach(a => {
      jabatanData[a.Jabatan] = (jabatanData[a.Jabatan] || 0) + 1;
    });

    const statusData = { Selesai: 0, Proses: 0, Belum: 0 };
    allAduan.forEach(a => {
      if (a.Status.includes("Selesai")) statusData.Selesai++;
      else if (a.Status.includes("Proses")) statusData.Proses++;
      else statusData.Belum++;
    });

    // Chart Jabatan
    new Chart(document.getElementById("chartJabatan"), {
      type: 'bar',
      data: {
        labels: Object.keys(jabatanData),
        datasets: [{
          label: 'Jumlah Aduan',
          data: Object.values(jabatanData),
          backgroundColor: '#0d6efd'
        }]
      }
    });

    // Chart Status
    new Chart(document.getElementById("chartStatus"), {
      type: 'doughnut',
      data: {
        labels: ['Selesai', 'Dalam Proses', 'Belum Ditanggapi'],
        datasets: [{
          data: [statusData.Selesai, statusData.Proses, statusData.Belum],
          backgroundColor: ['#198754', '#ffc107', '#dc3545']
        }]
      }
    });

    // Ringkasan
    document.getElementById("summaryStats").innerHTML = `
      <li>Total Aduan: ${allAduan.length}</li>
      <li>Selesai: ${statusData.Selesai}</li>
      <li>Dalam Proses: ${statusData.Proses}</li>
      <li>Belum Ditanggapi: ${statusData.Belum}</li>
    `;
  }

  // Load saat halaman siap
  document.addEventListener("DOMContentLoaded", () => {
    loadData();
    setInterval(loadData, 30000); // Refresh tiap 30 detik
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
